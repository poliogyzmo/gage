<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Jeu Ext√©rieur</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui}
.hidden{display:none}
.screen{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center}
.scenarios{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;width:90%;max-width:900px}
.card{position:relative;border-radius:16px;overflow:hidden;cursor:pointer}
.card img{width:100%;height:300px;object-fit:cover;filter:brightness(.7)}
.card span{position:absolute;bottom:0;left:0;right:0;padding:12px;background:rgba(0,0,0,.6);font-weight:700;text-align:center}

#gif{position:absolute;inset:0;width:100%;height:100%;object-fit:contain}
#texte{position:absolute;top:4%;left:50%;transform:translateX(-50%);
background:rgba(0,0,0,.5);padding:10px 16px;border-radius:10px;
font-weight:700;text-align:center;max-width:90%}

.controls{position:fixed;bottom:4%;left:50%;transform:translateX(-50%);
display:flex;gap:12px}
button{padding:10px 16px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
.next{background:#00ff99;color:#000}
.change{background:#555;color:#fff}
</style>
</head>

<body>

<!-- √âCRAN SC√âNARIOS -->
<div id="select" class="screen">
  <h1>Choisissez votre sc√©nario</h1>
  <div class="scenarios">
    <div class="card" data-s="balade">
      <img src="assets/scenarios/balade.jpg"><span>Balade / Promenade</span>
    </div>
    <div class="card" data-s="shopping">
      <img src="assets/scenarios/shopping.jpg"><span>Sortie Shopping</span>
    </div>
    <div class="card" data-s="bar">
      <img src="assets/scenarios/bar.jpg"><span>Bar / Restaurant</span>
    </div>
    <div class="card" data-s="voiture">
      <img src="assets/scenarios/voiture.jpg"><span>Vir√©e en voiture</span>
    </div>
  </div>
</div>

<!-- JEU -->
<div id="game" class="hidden">
  <img id="gif">
  <div id="texte">Chargement‚Ä¶</div>

  <div class="controls">
    <button class="change">üîÑ Changer</button>
    <button class="next">‚è≠ Suivant</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"

const supabase = createClient(
  "https://yqqhvanwoxmnakmzaqya.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxcWh2YW53b3htbmFrbXphcXlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MjA4NzYsImV4cCI6MjA3NjA5Njg3Nn0.eEHQBsTKNP9_nQ6LqFBjVgx_9WX9pY1uyX7xaedvn0o"
)

const STORAGE_KEY = "jeu_exterieur_v1"

const selectScreen = document.getElementById("select")
const gameScreen = document.getElementById("game")
const gif = document.getElementById("gif")
const texte = document.getElementById("texte")
const nextBtn = document.querySelector(".next")
const changeBtn = document.querySelector(".change")

let sequence = []
let index = 0
let scenario = ""

const SCENARIOS = {
  balade: [
    { joueur:1, genre:'homme', type:'depart' },
    { joueur:2, genre:'femme', type:'depart' },
    { joueur:1, genre:'homme', niveau:'debut' },
    { joueur:2, genre:'femme', niveau:'debut' },
    { joueur:1, genre:'mixte', niveau:'mains' },
    { joueur:2, genre:'mixte', niveau:'bouche' }
  ],
  shopping: [
    { joueur:1, genre:'femme', type:'depart' },
    { joueur:2, genre:'homme', type:'depart' },
    { joueur:1, genre:'femme', niveau:'debut' },
    { joueur:2, genre:'homme', niveau:'mains' }
  ],
  bar: [
    { joueur:1, genre:'mixte', type:'depart' },
    { joueur:2, genre:'mixte', type:'depart' },
    { joueur:1, genre:'homme', niveau:'bouche' },
    { joueur:2, genre:'femme', niveau:'bouche' }
  ],
  voiture: [
    { joueur:1, genre:'mixte', type:'depart' },
    { joueur:2, genre:'mixte', type:'depart' },
    { joueur:1, genre:'homme', niveau:'avance' },
    { joueur:2, genre:'femme', niveau:'avance' }
  ]
}

async function fetchGage(step){
  let q = supabase.from("gages").select("*")
    .eq("lieu","ext√©rieur")
    .eq("lieuext",scenario)
    .or(`genre.eq.${step.genre},genre.eq.mixte`)

  if(step.type) q = q.eq("type",step.type)
  if(step.niveau) q = q.eq("niveau",step.niveau)

  const { data } = await q.limit(100)
  return data?.length
    ? data[Math.floor(Math.random()*data.length)]
    : null
}

async function buildSequence(){
  sequence=[]
  for(const step of SCENARIOS[scenario]){
    const g = await fetchGage(step)
    if(g) sequence.push(g)
  }
}

function render(){
  const g = sequence[index]
  if(!g){ texte.textContent="Fin üéâ"; gif.src=""; return }
  texte.textContent = g.texte
  gif.src = g.gif_url || ""
  save()
}

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    scenario, index, sequence
  }))
}

function load(){
  const s = localStorage.getItem(STORAGE_KEY)
  if(!s) return false
  const d = JSON.parse(s)
  scenario=d.scenario
  index=d.index
  sequence=d.sequence
  return true
}

document.querySelectorAll(".card").forEach(c=>{
  c.onclick=async()=>{
    scenario=c.dataset.s
    selectScreen.classList.add("hidden")
    gameScreen.classList.remove("hidden")
    await buildSequence()
    render()
  }
})

nextBtn.onclick=()=>{ index++; render() }
changeBtn.onclick=async()=>{
  const step = SCENARIOS[scenario][index]
  const g = await fetchGage(step)
  if(g){ sequence[index]=g; render() }
}

if(load()){
  selectScreen.classList.add("hidden")
  gameScreen.classList.remove("hidden")
  render()
}
</script>
</body>
</html>
