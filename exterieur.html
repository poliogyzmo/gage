<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Jeu de Gages â€“ ExtÃ©rieur</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{
    margin:0;
    background:#000;
    color:#fff;
    font-family:system-ui,Segoe UI,Arial;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
  }
  .box{
    width:100%;
    max-width:500px;
    padding:20px;
    text-align:center;
  }
  h1{margin-bottom:20px}
  button{
    width:100%;
    margin:8px 0;
    padding:14px;
    font-size:16px;
    font-weight:700;
    border-radius:10px;
    border:none;
    cursor:pointer;
    background:#00ff99;
    color:#000;
  }
  .alt{background:#555;color:#fff}
  #texte{margin:20px 0;font-size:18px}
  #gif{width:100%;max-height:50vh;object-fit:contain}
</style>
</head>
<body>

<div class="box" id="screen-scenario">
  <h1>Choisis un scÃ©nario</h1>
  <button onclick="startScenario('balade')">ğŸš¶ Balade / Promenade</button>
  <button onclick="startScenario('shopping')">ğŸ› Shopping</button>
  <button onclick="startScenario('bar')">ğŸ· Bar / Resto</button>
  <button onclick="startScenario('voiture')">ğŸš— VirÃ©e en voiture</button>
</div>

<div class="box" id="screen-game" style="display:none">
  <div id="texte">Chargementâ€¦</div>
  <img id="gif" src="" alt="">
  <button onclick="nextGage()">â¡ï¸ Suivant</button>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://yqqhvanwoxmnakmzaqya.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxcWh2YW53b3htbmFrbXphcXlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MjA4NzYsImV4cCI6MjA3NjA5Njg3Nn0.eEHQBsTKNP9_nQ6LqFBjVgx_9WX9pY1uyX7xaedvn0o'
)

const STORAGE_KEY = 'jeu_exterieur_progress'

let state = {
  scenario: null,
  index: 0,
  sequence: [],
  players: [
    { name:'Joueur 1', genre:'homme' },
    { name:'Joueur 2', genre:'femme' }
  ]
}

const texte = document.getElementById('texte')
const gif = document.getElementById('gif')

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state))
}

function load(){
  const s = localStorage.getItem(STORAGE_KEY)
  if(s) state = JSON.parse(s)
}

async function fetchGage({genre, niveau, lieuext}){
  const { data } = await supabase
    .from('gages')
    .select('*')
    .eq('lieu','extÃ©rieur')
    .eq('lieuext', lieuext)
    .eq('niveau', niveau)
    .or(`genre.eq.${genre},genre.eq.mixte`)
    .limit(50)

  if(!data?.length) return null
  return data[Math.floor(Math.random()*data.length)]
}

async function startScenario(lieuext){
  state.scenario = lieuext
  state.index = 0
  state.sequence = []

  // gage dÃ©part pour chaque joueur
  for(const player of state.players){
    const g = await fetchGage({
      genre: player.genre,
      niveau: 'depart',
      lieuext
    })
    if(g) state.sequence.push(g)
  }

  save()
  showGame()
}

function showGame(){
  document.getElementById('screen-scenario').style.display='none'
  document.getElementById('screen-game').style.display='block'
  render()
}

function render(){
  const g = state.sequence[state.index]
  if(!g){
    texte.textContent = 'ğŸ‰ Fin du scÃ©nario'
    gif.src = ''
    return
  }
  texte.textContent = g.texte
  gif.src = g.gif_url || ''
}

async function nextGage(){
  state.index++

  // si on arrive Ã  la fin, on gÃ©nÃ¨re le suivant
  if(state.index >= state.sequence.length){
    const niveau = 'avance' // progression simple (Ã  affiner ensuite)
    const player = state.players[state.index % 2]

    const g = await fetchGage({
      genre: player.genre,
      niveau,
      lieuext: state.scenario
    })
    if(g) state.sequence.push(g)
  }

  save()
  render()
}

// reprise auto
load()
if(state.scenario){
  showGame()
}
</script>

</body>
</html>
