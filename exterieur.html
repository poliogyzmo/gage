<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Jeu Ext√©rieur</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{margin:0;background:#000;color:#fff;font-family:system-ui}
.screen{display:none;min-height:100vh;align-items:center;justify-content:center;flex-direction:column}
.screen.active{display:flex}
input,select,button{
  padding:12px;margin:6px;border-radius:8px;border:none
}
button{background:#00ff99;font-weight:700;cursor:pointer}
#texte{padding:20px;text-align:center;font-size:5vw}
</style>
</head>

<body>

<!-- SETUP -->
<div id="setup" class="screen active">
  <h2>Configuration</h2>
  <input id="p1name" placeholder="Pr√©nom joueur 1">
  <select id="p1genre">
    <option value="homme">Homme</option>
    <option value="femme">Femme</option>
  </select>

  <input id="p2name" placeholder="Pr√©nom joueur 2">
  <select id="p2genre">
    <option value="femme">Femme</option>
    <option value="homme">Homme</option>
  </select>

  <button onclick="goSelect()">Continuer</button>
</div>

<!-- SELECT -->
<div id="select" class="screen">
  <h2>Choisis un sc√©nario</h2>
  <button onclick="chooseScenario('balade')">Balade</button>
  <button onclick="chooseScenario('shopping')">Shopping</button>
  <button onclick="chooseScenario('bar')">Bar / resto</button>
  <button onclick="chooseScenario('voiture')">Voiture</button>
</div>

<!-- VOITURE -->
<div id="voiture" class="screen">
  <h2>Qui conduit ?</h2>
  <button onclick="setDriver(0)">Joueur 1</button>
  <button onclick="setDriver(1)">Joueur 2</button>
</div>

<!-- GAME -->
<div id="game" class="screen">
  <div id="texte"></div>
  <button onclick="next()">Suivant</button>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  'https://yqqhvanwoxmnakmzaqya.supabase.co',
  'TON_ANON_KEY'
)

const SCENARIOS = {
  balade:{ordre:['depart','niveau1','niveau2','fin']},
  shopping:{ordre:['depart','niveau1','niveau2','fin']},
  bar:{ordre:['depart','niveau1','niveau2','fin']},
  voiture:{ordre:['depart','niveau1','niveau2','fin']}
}

let state = {
  scenario:null,
  step:0,
  players:[],
  driver:null,
  sequence:[]
}

const screens = {
  setup:setup,
  select:select,
  voiture:voiture,
  game:game
}

function show(id){
  Object.values(screens).forEach(s=>s.classList.remove('active'))
  screens[id].classList.add('active')
}

function goSelect(){
  state.players = [
    {name:p1name.value, genre:p1genre.value},
    {name:p2name.value, genre:p2genre.value}
  ]
  show('select')
}

function chooseScenario(s){
  state.scenario = s
  state.step = 0
  state.sequence = []
  if(s === 'voiture') show('voiture')
  else start()
}

function setDriver(i){
  state.driver = i
  start()
}

async function fetchGage(player, niveau){
  let q = supabase.from('gages')
    .select('*')
    .eq('lieu','ext√©rieur')
    .eq('lieuext',state.scenario)
    .eq('niveau',niveau)
    .or(`genre.eq.${player.genre},genre.eq.mixte`)
    .limit(20)

  if(state.scenario === 'voiture'){
    q = q.eq(
      'voiture',
      state.players.indexOf(player) === state.driver
        ? 'conducteur'
        : 'passager'
    )
  }

  const { data } = await q
  return data?.length ? data[Math.floor(Math.random()*data.length)] : null
}

async function start(){
  for(const niveau of SCENARIOS[state.scenario].ordre){
    for(const p of state.players){
      const g = await fetchGage(p,niveau)
      if(g) state.sequence.push({p:p.name, texte:g.texte})
    }
  }
  show('game')
  render()
}

function render(){
  const g = state.sequence[state.step]
  texte.textContent = g ? `${g.p} : ${g.texte}` : 'üéâ Fin du sc√©nario'
}

function next(){
  state.step++
  render()
}

/* expose */
window.goSelect = goSelect
window.chooseScenario = chooseScenario
window.setDriver = setDriver
window.next = next
</script>

</body>
</html>
