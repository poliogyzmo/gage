<!DOCTYPE html> 
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Jeu de Gages - Partie</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--accent:#00ff99}
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,Segoe UI,Arial;}
  .app{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden}
  #gif{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;z-index:1;background:#000}
  #texte{position:absolute;top:4%;left:50%;transform:translateX(-50%);z-index:2;background:rgba(0,0,0,0.45);padding:8px 14px;border-radius:8px;font-weight:700;font-size:1.6vw;max-width:86%;text-align:center}
  @media(max-width:768px){#texte{font-size:4.5vw}}
  .controls{position:fixed;bottom:4%;left:50%;transform:translateX(-50%);display:flex;gap:12px;z-index:3}
  .btn{background:var(--accent);border:none;color:#000;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.alt{background:#666;color:#fff}
  #progress{position:fixed;bottom:0;left:0;height:5px;background:var(--accent);width:0%;z-index:4;transition:width .4s ease}
  .status{position:fixed;top:12px;right:12px;background:rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;font-size:13px;z-index:5}
</style>
</head>
<body>
<div class="app">
  <img id="gif" src="" alt="gif"/>
  <div id="texte">Chargement... Patientez</div>

  <div class="controls">
    <button id="changeBtn" class="btn alt">üîÑ Changer</button>
    <button id="nextBtn" class="btn">‚è≠ Suivant</button>
  </div>

  <div id="progress"></div>
  <div class="status" id="status">Pr√™t</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const SUPABASE_URL = 'https://yqqhvanwoxmnakmzaqya.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxcWh2YW53b3htbmFrbXphcXlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MjA4NzYsImV4cCI6MjA3NjA5Njg3Nn0.eEHQBsTKNP9_nQ6LqFBjVgx_9WX9pY1uyX7xaedvn0o'
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

const texteDiv = document.getElementById('texte')
const gifImg = document.getElementById('gif')
const nextBtn = document.getElementById('nextBtn')
const changeBtn = document.getElementById('changeBtn')
const progressBar = document.getElementById('progress')
const status = document.getElementById('status')

let sequence = []
let index = 0
const usedIds = new Set()
let player1 = {}, player2 = {}, scenario = ''

// lecture des param√®tres depuis URL
function readParams() {
  const qs = Object.fromEntries(new URL(location.href).searchParams.entries())
  return {
    joueur1: qs.joueur1 || '',
    genre1: qs.genre1 || 'femme',
    specials1: qs.special1 ? qs.special1.split(',') : ['non'],
    joueur2: qs.joueur2 || '',
    genre2: qs.genre2 || 'homme',
    specials2: qs.special2 ? qs.special2.split(',') : ['non'],
    scenario: qs.scenario || 'soft_court'
  }
}

// Helper pour s√©lectionner un gage unique
function pickUnique(cands){
  const avail = cands.filter(c => !usedIds.has(c.id))
  return avail.length ? avail[Math.floor(Math.random()*avail.length)] : cands[Math.floor(Math.random()*cands.length)]
}

// Helper pour g√©rer l'ambiance
function pickAmbiance(a){
  if(a === 'mixed_dom') return Math.random() < 0.5 ? 'domination' : 'bondage'
  return a
}

// fetch candidats Supabase avec filtre sur gage sp√©cial multiple
async function fetchCandidates({genre, niveau, ambiance, specials}) {
  specials = specials || ['non']
  const { data, error } = await supabase
    .from('gages')
    .select('*')
    .eq('lieu','interieur')
    .or(`genre.eq.${genre},genre.eq.mixte`)
    .eq('niveau', niveau)
    .in('ambiance', [ambiance])
    .limit(500)

  if(error){console.error(error); return []}
  if(!data?.length) return []

  const filtered = data.filter(g => {
    if(!g.type_special) return specials.includes('non')
    return specials.includes(g.type_special)
  })
  return filtered.length ? filtered : data
}

// --- BUILD SEQUENCE ---
async function buildSequence(scenarioName, players){
  const pattern = SCENARIOS[scenarioName]
  const seq = []

  for(const step of pattern){
    // Respecter le genre d√©fini dans le sc√©nario
    const target = step.genre === player1.genre ? player1 : player2
    target.specials = target.specials || ['non']

    let niveau = step.niveau
    if(niveau === 'anal' && !target.specials.includes('oui')){
      niveau = 'avance'
    }

    const amb = pickAmbiance(step.ambiance)
    const candidates = await fetchCandidates({
      genre: target.genre,
      niveau: niveau,
      ambiance: amb,
      specials: target.specials
    })

    const chosen = pickUnique(candidates)
    if(chosen) usedIds.add(chosen.id)
    seq.push({...chosen, requestedAmbiance: amb, originalNiveau: step.niveau})
  }

  return seq
}


// --- RENDER ---
function renderCurrent(){
  const g = sequence[index]
  if(!g){texteDiv.textContent='Aucun gage';gifImg.src='';return}

  // d√©terminer le nom du joueur cible (oppos√© au genre du gage)
  let partnerName = ''
  if(g.genre === player1.genre && player2.name) partnerName = player2.name
  else if(g.genre === player2.genre && player1.name) partnerName = player1.name
  else partnerName = player1.name || player2.name

  texteDiv.textContent = `${partnerName} : ${g.texte || '‚Äî'}`
  gifImg.src = g.gif_url || ''
  progressBar.style.width = `${Math.round(((index+1)/sequence.length)*100)}%`
  status.textContent = `Gage ${index+1}/${sequence.length}`
}

// --- EVENTS ---
nextBtn.onclick = () => {
  if(index < sequence.length-1){index++;renderCurrent()}
  else{status.textContent='Fin üéâ';texteDiv.textContent='üéâ Fin du jeu';gifImg.src=''}
}

// changer gage (plusieurs fois possible)
changeBtn.onclick = async () => {
  const g = sequence[index]
  const target = (g.genre === player1.genre ? player1 : player2) || player1
  const niveau = (g.originalNiveau==='anal' && !target.specials.includes('oui')) ? 'avance' : g.originalNiveau
  const cands = await fetchCandidates({
    genre: target.genre,
    niveau: niveau,
    ambiance: g.requestedAmbiance,
    specials: target.specials
  })
  const newG = pickUnique(cands)
  if(newG){sequence[index]=newG;renderCurrent()}
}

// initialisation
async function startGame(){
  const params = readParams()
  player1 = {
    name: params.joueur1,
    genre: params.genre1,
    specials: params.specials1
  }
  player2 = {
    name: params.joueur2,
    genre: params.genre2,
    specials: params.specials2
  }
  scenario = params.scenario
  index = 0
  usedIds.clear()
  status.textContent = 'G√©n√©ration des gages...'
  sequence = await buildSequence(scenario, [player1, player2])
  renderCurrent()
}

// --- SCENARIOS ---
const SCENARIOS = {
 soft_court: [ 
    {genre:'homme', niveau:'debut', ambiance:'romantique'}, 
    {genre:'femme', niveau:'debut', ambiance:'romantique'},  
    {genre:'homme', niveau:'mains', ambiance:'romantique'}, 
    {genre:'femme', niveau:'mains', ambiance:'romantique'}, 
    {genre:'homme', niveau:'bouche', ambiance:'romantique'}, 
    {genre:'femme', niveau:'bouche', ambiance:'romantique'}, 
    {genre:'homme', niveau:'avance', ambiance:'romantique'}, 
    {genre:'femme', niveau:'avance', ambiance:'romantique'} ], 
  
  soft_long: [ 
    {genre:'homme', niveau:'debut', ambiance:'romantique'}, 
    {genre:'homme', niveau:'debut', ambiance:'romantique'}, 
    {genre:'femme', niveau:'debut', ambiance:'romantique'},  
    {genre:'femme', niveau:'debut', ambiance:'romantique'},     
    {genre:'homme', niveau:'mains', ambiance:'romantique'}, 
    {genre:'femme', niveau:'mains', ambiance:'romantique'}, 
    {genre:'homme', niveau:'mains', ambiance:'romantique'}, 
    {genre:'femme', niveau:'mains', ambiance:'romantique'}, 
    {genre:'homme', niveau:'bouche', ambiance:'romantique'}, 
    {genre:'femme', niveau:'bouche', ambiance:'romantique'}, 
    {genre:'homme', niveau:'bouche', ambiance:'romantique'}, 
    {genre:'femme', niveau:'bouche', ambiance:'romantique'}, 
    {genre:'homme', niveau:'avance', ambiance:'romantique'}, 
    {genre:'femme', niveau:'avance', ambiance:'romantique'}, 
    {genre:'homme', niveau:'avance', ambiance:'romantique'}, 
    {genre:'femme', niveau:'avance', ambiance:'romantique'},
    {genre:'homme', niveau:'anal', ambiance:'romantique'}, 
    {genre:'femme', niveau:'anal', ambiance:'romantique'}
  ], 

progressif: [ 
    {genre:'homme', niveau:'debut', ambiance:'romantique'}, 
    {genre:'femme', niveau:'debut', ambiance:'romantique'},  
    {genre:'femme', niveau:'debut', ambiance:'domination'},  
    {genre:'femme', niveau:'debut', ambiance:'domination'},     
    {genre:'homme', niveau:'mains', ambiance:'romantique'}, 
    {genre:'femme', niveau:'mains', ambiance:'romantique'}, 
    {genre:'homme', niveau:'mains', ambiance:'domination'}, 
    {genre:'femme', niveau:'mains', ambiance:'domination'}, 
    {genre:'homme', niveau:'bouche', ambiance:'romantique'}, 
    {genre:'femme', niveau:'bouche', ambiance:'romantique'}, 
    {genre:'homme', niveau:'bouche', ambiance:'domination'},
    {genre:'femme', niveau:'bouche', ambiance:'domination'},
    {genre:'homme', niveau:'avance', ambiance:'romantique'}, 
    {genre:'femme', niveau:'avance', ambiance:'romantique'},
    {genre:'homme', niveau:'avance', ambiance:'domination'},
    {genre:'femme', niveau:'avance', ambiance:'domination'},
    {genre:'femme', niveau:'anal', ambiance:'domination'},
    {genre:'femme', niveau:'anal', ambiance:'domination'}
   ],

 bdsm: [ 
 {genre:'femme', niveau:'debut', ambiance:'domination'}, 
 {genre:'femme', niveau:'debut', ambiance:'bondage'},
 {genre:'homme', niveau:'debut', ambiance:'domination'},
 {genre:'homme', niveau:'debut', ambiance:'bondage'},
   {genre:'homme', niveau:'mains', ambiance:'domination'},
 {genre:'homme', niveau:'mains', ambiance:'bondage'},
 {genre:'femme', niveau:'mains', ambiance:'domination'}, 
{genre:'femme', niveau:'mains', ambiance:'bondage'}, 
{genre:'femme', niveau:'bouche', ambiance:'domination'}, 
{genre:'femme', niveau:'bouche', ambiance:'bondage'}, 
 {genre:'homme', niveau:'bouche', ambiance:'domination'}, 
{genre:'homme', niveau:'bouche', ambiance:'bondage'},
 {genre:'homme', niveau:'avance', ambiance:'domination'}, 
{genre:'femme', niveau:'avance', ambiance:'bondage'},
  {genre:'homme', niveau:'anal', ambiance:'domination'},
 {genre:'femme', niveau:'anal', ambiance:'bondage'}
 ], 

domination: [ 

 {genre:'femme', niveau:'debut', ambiance:'domination'}, 
{genre:'femme', niveau:'debut', ambiance:'domination'}, 
 {genre:'homme', niveau:'debut', ambiance:'domination'},
 {genre:'homme', niveau:'debut', ambiance:'domination'},
 {genre:'homme', niveau:'mains', ambiance:'domination'},
 {genre:'homme', niveau:'mains', ambiance:'domination'},
 {genre:'femme', niveau:'mains', ambiance:'domination'}, 
{genre:'femme', niveau:'mains', ambiance:'domination'}, 
{genre:'femme', niveau:'bouche', ambiance:'domination'}, 
{genre:'femme', niveau:'bouche', ambiance:'domination'}, 
 {genre:'homme', niveau:'bouche', ambiance:'domination'}, 
{genre:'homme', niveau:'bouche', ambiance:'domination'}, 
{genre:'homme', niveau:'avance', ambiance:'domination'},
 {genre:'femme', niveau:'avance', ambiance:'domination'} ,
  {genre:'homme', niveau:'anal', ambiance:'domination'},
 {genre:'femme', niveau:'anal', ambiance:'domination'}
 ], 
    
 bondage: [ 
 {genre:'femme', niveau:'debut', ambiance:'bondage'}, 
{genre:'femme', niveau:'debut', ambiance:'bondage'},
 {genre:'homme', niveau:'debut', ambiance:'bondage'},
 {genre:'homme', niveau:'debut', ambiance:'bondage'},
   {genre:'homme', niveau:'mains', ambiance:'bondage'},
 {genre:'homme', niveau:'mains', ambiance:'bondage'},
 {genre:'femme', niveau:'mains', ambiance:'bondage'}, 
{genre:'femme', niveau:'mains', ambiance:'bondage'}, 
 {genre:'femme', niveau:'bouche', ambiance:'bondage'},
 {genre:'femme', niveau:'bouche', ambiance:'bondage'},
{genre:'homme', niveau:'bouche', ambiance:'bondage'}, 
{genre:'homme', niveau:'bouche', ambiance:'bondage'},
 {genre:'homme', niveau:'avance', ambiance:'bondage'},
 {genre:'femme', niveau:'avance', ambiance:'bondage'},
  {genre:'homme', niveau:'anal', ambiance:'bondage'},
 {genre:'femme', niveau:'anal', ambiance:'bondage'}
 ], 

     femdom: [ 
 {genre:'homme', niveau:'debut', ambiance:'domination'},
 {genre:'homme', niveau:'debut', ambiance:'domination'},
 {genre:'homme', niveau:'debut', ambiance:'domination'},
 {genre:'homme', niveau:'mains', ambiance:'domination'}, 
 {genre:'homme', niveau:'mains', ambiance:'domination'}, 
 {genre:'homme', niveau:'mains', ambiance:'domination'},
 {genre:'homme', niveau:'bouche', ambiance:'domination'},
 {genre:'homme', niveau:'bouche', ambiance:'domination'},
 {genre:'homme', niveau:'avance', ambiance:'domination'}, 
 {genre:'homme', niveau:'avance', ambiance:'domination'}, 
 {genre:'homme', niveau:'anal', ambiance:'domination'}
   ], 

     maledom: [ 
 {genre:'femme', niveau:'debut', ambiance:'domination'},
 {genre:'femme', niveau:'debut', ambiance:'domination'},
 {genre:'femme', niveau:'debut', ambiance:'domination'},
 {genre:'femme', niveau:'mains', ambiance:'domination'}, 
 {genre:'femme', niveau:'mains', ambiance:'domination'}, 
 {genre:'femme', niveau:'mains', ambiance:'domination'},
 {genre:'femme', niveau:'bouche', ambiance:'domination'},
 {genre:'femme', niveau:'bouche', ambiance:'domination'},
 {genre:'femme', niveau:'avance', ambiance:'domination'}, 
 {genre:'femme', niveau:'avance', ambiance:'domination'}, 
 {genre:'femme', niveau:'anal', ambiance:'domination'}
   ], 
    
    
    switch: [ 
 {genre:'homme', niveau:'debut', ambiance:'domination'},
 {genre:'homme', niveau:'debut', ambiance:'bondage'},
{genre:'homme', niveau:'mains', ambiance:'domination'}, 
{genre:'homme', niveau:'mains', ambiance:'bondage'},
 {genre:'homme', niveau:'bouche', ambiance:'domination'},
{genre:'homme', niveau:'avance', ambiance:'domination'}, 
 {genre:'homme', niveau:'anal', ambiance:'domination'}, 
 {genre:'femme', niveau:'debut', ambiance:'domination'}, 
{genre:'femme', niveau:'debut', ambiance:'bondage'},
 {genre:'femme', niveau:'mains', ambiance:'domination'},
 {genre:'femme', niveau:'mains', ambiance:'bondage'},
 {genre:'femme', niveau:'bouche', ambiance:'domination'},
 {genre:'femme', niveau:'avance', ambiance:'domination'},
    {genre:'femme', niveau:'anal', ambiance:'domination'}
 ] 
}
startGame()
  
</script>
</body>
</html>











